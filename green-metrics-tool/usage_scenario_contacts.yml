---
name: Nextcloud - MariaDB - Install - Firefox
author: Arne Tarara <arne@green-coding.io> + Didi Hoffmann <didi@green-coding.io>
description: Nexcloud Contacts Scenario
compose-file: !include compose.yml

services:
  gcb-playwright:
    image: greencoding/gcb_playwright:v21
#    depends_on:
#      nc:
#        condition: service_healthy
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix # for debugging in non-headless mode
    environment:
       DISPLAY: ":0" # for debugging in non-headless mode
    setup-commands:
      - command: pip install dotenv

# this code will never support local filenames
# as it anyway would require a change in the usage scenario file
# since that is the case a local dev could also just mount a local folder which is already
# a supported feature
relations:
  contacts: # will be put in /tmp/relations/calendar
    url: https://github.com/green-coding-solutions/nextcloud-contacts
    branch: green-metrics-tool
    # commit_hash: ghhkshfkjsdnfk # no commit means latest


flow:
  - name: Install Nextcloud
    container: gcb-playwright
    commands:
      - type: console
        command: python3 /tmp/relations/contacts/green-metrics-tool/nextcloud_install.py firefox

  - name: Install Apps
    container: app
    commands:
      - type: console
        command: |
          mkdir /var/www/html/apps/contacts/ \
          && cp -r /tmp/relations/contacts/* /var/www/html/apps/contacts/\
          && chown -R www-data:www-data /var/www/html/apps/contacts/ \
          && cd /var/www/html/apps/contacts/ \
          && sudo -u www-data composer install --no-dev \
          && sudo -u www-data npm ci \
          && sudo -u www-data npm run build \
          && sudo -u www-data php /var/www/html/occ app:enable contacts
        shell: bash

  - name: Contacts
    container: gcb-playwright
    commands:
      - type: console
        command: python3 /tmp/relations/contacts/green-metrics-tool/nextcloud_contacts.py firefox
        note: Creating event
        read-notes-stdout: true
        read-sci-stdout: true
        log-stdout: true
        log-stderr: true
